@page "/detailed-report"
@using System.Security.Claims
@using Warehouse.Core.Dtos
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer


<PageTitle>Детализированный отчет движения заготовок</PageTitle>

<div class="container mt-3">
    <div class="no-print">
        <NavMenu></NavMenu>

        <!-- Панель управления -->
        <div class="card p-3 mb-3">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <label class="form-label"><strong>Дата отчета:</strong></label>
                    <InputDate @bind-Value="selectedDate" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label"><strong>Склад:</strong></label>
                    <InputSelect @bind-Value="selectedWarehouseId" class="form-select">
                        @foreach (var warehouse in warehouses)
                        {
                            <option value="@warehouse.Id">@warehouse.Name</option>
                        }
                    </InputSelect>
                </div>
                <div class="col-md-4">
                    <div class="d-flex gap-2 mt-4">
                        <button @onclick="GenerateReport" class="btn btn-primary">
                            <i class="fas fa-chart-bar"></i> Сформировать отчет
                        </button>
                        <button @onclick="PrintReport" class="btn btn-outline-secondary">
                            <i class="fas fa-print"></i> Печать
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center p-4 no-print">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <div class="mt-2">Формирование отчета...</div>
        </div>
    }
    else if (reportData != null && reportData.Any())
    {
        <!-- Контейнер отчета для печати -->
        <div class="report-container" id="report-container">
            <!-- Заголовки, которые скрываются при печати -->
            <h1 class="report-title no-print"><u>ОТЧЁТ О ДВИЖЕНИИ ЗАГОТОВОК</u></h1>
            <h3 class="report-title no-print">Склад: @GetWarehouseName(selectedWarehouseId)</h3>

            <!-- Заголовок даты, который виден при печати -->
            <h2 class="report-title print-only"><u>@selectedDate.ToString("dd MMMM yyyy")</u></h2>

            <table aria-label="Данные по движению заготовок">
                <thead>
                    <tr class="header-row">
                        <th rowspan="3" style="width: 40px;">№ п.п</th>
                        <th rowspan="3" style="width:180px;">Тип заготовки</th>
                        <th rowspan="3" style="width: 65px;">На начало дня</th>
                        <th colspan="4">Приход</th>
                        <th colspan="6">Расход</th>
                        <th rowspan="3" style="width: 86px;">На конец дня</th>
                    </tr>
                    <tr class="subheader-row">
                        <th colspan="2" scope="col">Поступление из центрального склада</th>
                        <th colspan="2" scope="col">Возвращение брака</th>
                        <th colspan="2" scope="col">Передано в производство</th>
                        <th colspan="2" scope="col">Передано в другой склад</th>
                        <th colspan="2" scope="col">Списание на уничтожение</th>
                    </tr>
                    <tr class="header-row">
                        <th scope="col">Кол‑во</th>
                        <th scope="col">Основание</th>
                        <th scope="col">Кол‑во</th>
                        <th scope="col">Основание</th>
                        <th scope="col">Кол‑во</th>
                        <th scope="col">Основание</th>
                        <th scope="col">Кол‑во</th>
                        <th scope="col">Основание</th>
                        <th scope="col">Кол‑во</th>
                        <th scope="col">Основание</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int index = 1;
                        int totalReceipt = 0;
                        int totalIssue = 0;
                        int totalTransfer = 0;
                        int totalWriteOff = 0;
                    }
                    @foreach (var item in reportData)
                    {
                        totalReceipt += item.ReceiptFromCentral;
                        totalIssue += item.IssuedToProduction;
                        totalTransfer += item.TransferredToOtherWarehouse;
                        totalWriteOff += item.WrittenOff;

                        <tr class="data-row">
                            <td>@(index++)</td>
                            <td>@item.BlankName</td>
                            <td>@item.OpeningBalance</td>
                            <td>@item.ReceiptFromCentral</td>
                            <td>@item.ReceiptReference</td>
                            <td>@item.ReturnDefective</td>
                            <td>@item.ReturnDefectiveReference</td>
                            <td>@item.IssuedToProduction</td>
                            <td>@item.IssueReference</td>
                            <td>@item.TransferredToOtherWarehouse</td>
                            <td>@item.TransferReference</td>
                            <td>@item.WrittenOff</td>
                            <td>@item.WriteOffReference</td>
                            <td><strong>@item.ClosingBalance</strong></td>
                        </tr>
                    }
                    <!-- Итоговая строка -->
                    <tr class="total-row">
                        <td colspan="3"><strong>Итого</strong></td>
                        <td><strong>@totalReceipt</strong></td>
                        <td colspan="3"></td>
                        <td><strong>@totalIssue</strong></td>
                        <td></td>
                        <td><strong>@totalTransfer</strong></td>
                        <td></td>
                        <td><strong>@totalWriteOff</strong></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>

            <div class="signatures print-only">
                <div class="signature-line">
                    <span class="signature-label">Ответственный работник:</span>
                </div>
                <div class="signature-line">
                    <span class="signature-label">Ф.И.О.:</span>
                    <span class="signature-field"></span>
                    <span class="signature-label">&nbsp;&nbsp;Подпись:</span>
                    <span class="signature-field"></span>
                </div>

                <div class="signature-line">
                    <span class="signature-label">Контролирующий работник:</span>
                </div>
                <div class="signature-line">
                    <span class="signature-label">Ф.И.О.:</span>
                    <span class="signature-field"></span>
                    <span class="signature-label">&nbsp;&nbsp;Подпись:</span>
                    <span class="signature-field"></span>
                </div>
            </div>

        </div>
    }
    else if (reportData != null)
    {
        <div class="alert alert-info text-center no-print">
            <i class="fas fa-info-circle"></i> Нет данных для отчета за выбранную дату
        </div>
    }
</div>

<style>
    /* Стили из вашего HTML шаблона */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: Arial, sans-serif;
        color: #333;
        line-height: 1.4;
        padding: 20px;
    }

    .report-container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: #fff;
    }

    .report-title {
        text-align: center;
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 24px;
        letter-spacing: 0.5px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        margin-bottom: 20px;
        page-break-inside: avoid;
    }

    th, td {
        border: 1px solid #BFBFBF;
        padding: 8px 10px;
        text-align: center;
        vertical-align: middle;
        word-wrap: break-word;
        font-size: 12px;
    }

    th {
        background-color: #F2F2F2;
        font-weight: 600;
    }

    .header-row {
        height: 30px;
    }

    .subheader-row {
        height: 40px;
        font-size: 11px;
    }

    .data-row {
        height: 35px;
    }

    .total-row {
        background-color: #e6e6e6;
        font-weight: bold;
    }

    .signatures {
        margin-top: 30px;
        font-size: 13px;
    }

    .signature-line {
        display: flex;
        justify-content: space-between;
        margin: 12px 0;
        align-items: center;
    }

    .signature-label {
        white-space: nowrap;
        margin-right: 15px;
        flex-shrink: 0;
    }

    .signature-field {
        flex-grow: 1;
        border-bottom: 1px dashed #666;
        margin-left: 10px;
        min-height: 1em;
    }

    /* Стили для скрытия элементов при обычном просмотре */
    .print-only {
        display: none;
    }

    /* Стили для печати */
    @@media print {
        /* Скрываем элементы, которые не должны печататься */
        .no-print {
            display: none !important;
        }
        /* Показываем элементы только для печати */
        .print-only {
            display: block !important;
        }

        body {
            padding: 0;
            margin: 0;
            font-size: 10pt;
            background: white;
        }

        .container {
            max-width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        .report-container {
            max-width: 100%;
            padding: 0;
            margin: 0;
        }

        table {
            font-size: 9pt;
            page-break-inside: auto;
            width: 100%;
        }

        th, td {
            padding: 5px 7px;
            border-color: #999;
        }

        th {
            background-color: #f2f2f2 !important;
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
        }

        .total-row {
            background-color: #e6e6e6 !important;
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
        }

        .signature-field {
            border-bottom: 1px solid #000;
        }
        /* Альбомная ориентация и настройки страницы */
        @@page {
            margin: 15mm;
            size: A4 landscape;
            orphans: 3;
            widows: 3;
        }
        /* Убедимся, что таблица и подписи не разрываются между страницами */
        table {
            page-break-inside: avoid;
        }

        .signatures {
            page-break-inside: avoid;
        }
    }
</style>

@code {
    [Inject]
    public TransactionTypeService TransactionTypeService { get; set; }
    [Inject]
    public WarehousServise WarehousServise { get; set; }
    [Inject]
    public DetailedBalanceReportService DetailedBalanceReportService { get; set; }
    private DateTime selectedDate = DateTime.Today;
    private int selectedWarehouseId = 1;
    private List<DetailedBalanceReportDto> reportData;
    private List<WarehouseOutPutModel> warehouses = new();
    private ClaimsPrincipal user;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        user = authState.User;
        warehouses = await GetFilteredWarehousesAsync();
        if (warehouses.Any())
        {
            selectedWarehouseId = warehouses.First().Id;
        }
    }

    private async Task GenerateReport()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // Генерируем отчет за выбранную дату
            await DetailedBalanceReportService.GenerateDetailedReportAsync(selectedDate);

            // Получаем детализированные данные
            reportData = await DetailedBalanceReportService.GetDetailedReportAsync(selectedDate, selectedWarehouseId);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Ошибка при формировании отчета: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task PrintReport()
    {
        if (reportData == null || !reportData.Any())
        {
            await JSRuntime.InvokeVoidAsync("alert", "Сначала сформируйте отчет");
            return;
        }

        await JSRuntime.InvokeVoidAsync("print");
    }

    private string GetWarehouseName(int warehouseId)
    {
        return warehouses.FirstOrDefault(w => w.Id == warehouseId)?.Name ?? "Неизвестно";
    }

    private async Task<List<WarehouseOutPutModel>> GetFilteredWarehousesAsync()
    {
        var allWarehouses = WarehousServise.GetAll();

        if (user.IsInRole("Admin"))
        {
            return allWarehouses;
        }
        else if (user.IsInRole("User1"))
        {
            return allWarehouses.Where(w => w.Id == 1).ToList();
        }
        else if (user.IsInRole("User2"))
        {
            return allWarehouses.Where(w => w.Id == 2).ToList();
        }
        else
        {
            return new List<WarehouseOutPutModel>();
        }
    }
}