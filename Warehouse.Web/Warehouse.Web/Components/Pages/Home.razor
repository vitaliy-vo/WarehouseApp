@page "/"
@using System.Security.Claims
@rendermode InteractiveServer


<PageTitle>Home</PageTitle>
<AuthorizeView Roles="User1,User2,Admin">
    <Authorized>
        <p>авторизован</p>
    </Authorized>
    <NotAuthorized>
        <p>не авторизован</p>
    </NotAuthorized>
</AuthorizeView>
<div class="container" style="margin-buttom:10px,10px;" >
    <NavMenu></NavMenu>
    <p></p>
    <AuthorizeView Roles="User1,User2,Admin">
     <Authorized>
    <InputText @bind-Value="searshText" ></InputText>
    <InputSelect @bind-Value="@selectedId">
        <option value="0"></option>
        @foreach (var b in availableWarehouses)
        {
            <option value="@b">Хранилище @b</option>
        }

    </InputSelect>
    
    <button @onclick="OnFilter" type="button" class="btn btn-outline-primary shadow-none">Поиск</button>
  
    <button @onclick="ShowModel" type="button" class="btn btn-outline-primary  shadow-none">Добавить ценность</button>
    </Authorized>
    <NotAuthorized>
       
<div class="not-authorized">
    <div class="loading-animation"></div>
    <h4>Авторизация</h4>
    <p>Пожалуйста, войдите в систему для продолжения работы</p>
    <a href="/login" class="btn btn-primary">Войти</a>
</div>
    </NotAuthorized>
   </AuthorizeView>
</div>

<div class="container" style="display:flex; flex-wrap:wrap;">
    @foreach (var b in filtredBlanks)
{
    <BlankCard Blank="b"/>
}
</div>

@if (isModelShowed && blank != null)
{

    <!-- Modal -->
    <div class="modal show d-block fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true" style="background: rgba(0,128,255,0.3)">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-primary text-white">
                <div class="modal-header bg-info">
                    <h1 class="modal-title fs-5 text-white" id="staticBackdropLabel">Окно добавления ценности</h1>
                    <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Close" @onclick="HideModel"></button>
                </div>
                <EditForm Model="blank" OnValidSubmit="OnSubmit">
                    <DataAnnotationsValidator></DataAnnotationsValidator>
                    <div class="modal-body p-4 bg-light text-dark">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Хранилище</label>
                            <InputSelect class="form-select" @bind-Value="blank.IdWarehouse">
                                @foreach (var b in availableWarehouses)
                                {
                                    <option value="@b">Хранилище @b</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Артикул</label>
                            <InputText class="form-control" @bind-Value="blank.Article"></InputText>
                            <ValidationMessage For="() => blank.Article" class="text-danger"></ValidationMessage>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ценность</label>
                            <InputText class="form-control" @bind-Value="blank.NameValue"></InputText>
                            <ValidationMessage For="() => blank.NameValue" class="text-danger"></ValidationMessage>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Количество заготовок</label>
                            <InputNumber class="form-control" @bind-Value="blank.Count"></InputNumber>
                            <ValidationMessage For="() => blank.Count" class="text-danger"></ValidationMessage>
                        </div>
                        <div class="mb-3 form-check">
                            <InputCheckbox class="form-check-input" @bind-Value="blank.IsActive"></InputCheckbox>
                            <label class="form-check-label fw-bold">Продукт активный</label>
                        </div>
                    </div>
                    <div class="modal-footer bg-info">
                        <button type="button" class="btn btn-outline-light me-2" data-bs-dismiss="modal" @onclick="HideModel">Закрыть</button>
                        <button type="submit" class="btn btn-success">Добавить Ценность</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>

}
@code{
    [Inject]
    public BlankServise BlankServise { get; set; }

    [Inject]
    public AuthenticationStateProvider AuthenticationStateProvider { get; set; }

    private List<BlankOutPutModel> blanks = new();

    private List<BlankOutPutModel> filtredBlanks = new();

    private string searshText = "";

    private int selectedId { get; set; }

    private List<int> numbers = new();
    private List<int> availableWarehouses = new();

    private bool isModelShowed;

    private BlankInputModel? blank;
    
    private ClaimsPrincipal? user;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();

            user = authState.User;

            blanks = BlankServise.GetAll() ?? new();
            filtredBlanks = blanks;
            numbers = blanks.GroupBy(b => b.IdWarehouse)
                .Select(g => g.Key)
                .ToList();
            
            availableWarehouses = GetAvailableWarehouses();

            isModelShowed = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка инициализации: {ex.Message}");
            blanks = new();
            filtredBlanks = new();
            numbers = new();
            availableWarehouses = new();
        }
    }

    private List<int> GetAvailableWarehouses()
    {
        if (user == null) return new List<int>();

        if (user.IsInRole("Admin"))
        {
            // Админ видит все хранилища
            return numbers;
        }
        else if (user.IsInRole("User1"))
        {
            // User1 видит только хранилище 1
            return new List<int> { 1 };
        }
        else if (user.IsInRole("User2"))
        {
            // User2 видит только хранилище 2
            return new List<int> { 2 };
        }

        return new List<int>();
    }

    private void OnFilter()
    {
        string tmp = searshText.Trim().ToLower();
        filtredBlanks = blanks.Where(b => b.NameValue.ToLower().Contains(tmp)).ToList();
        if (selectedId != 0)
        {
            filtredBlanks = filtredBlanks.Where(b => b.IdWarehouse.Equals(selectedId)).ToList();
        }
        StateHasChanged();
    }
    private void ShowModel()
    {
        blank = new BlankInputModel();
        blank.IsActive = true;
        if (availableWarehouses.Any())
        {
            blank.IdWarehouse = availableWarehouses.First();
        }
        isModelShowed = true;
        StateHasChanged();

    }
    private void HideModel()
    {
        isModelShowed = false;
    }

   

    private void OnSubmit()
    {
        if (blank == null) return;
        
        var tmp = BlankServise.Add(blank);
        blanks.Add(tmp);
        filtredBlanks = blanks;
        HideModel();
        StateHasChanged();
    }

}